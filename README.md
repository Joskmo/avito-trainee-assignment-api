# Avito Trainee Assignment API

## Stack

- Golang 1.24
- PostgreSQL 18
- Goose
- sqlc
- Docker & Docker Compose

## Запуск

Для запуска сервиса и базы данных выполните команду:

```bash
make
```

или

```bash
docker compose up -d
```

Сервис будет доступен по адресу `http://localhost:8080`.
Миграции применятся автоматически при старте контейнера с миграциями.

## Допущения и решения

### `POST /team/add`

- Ручка `/team/add` используется **исключительно для создания новой команды**.
- Параметр `team_name` должен быть уникальным:
  - если команда с таким именем уже существует — возвращается ошибка `TEAM_EXISTS`, повторное создание запрещено.

- Поведение по отношению к пользователям:
  - если `user_id` не существует — создаётся новый пользователь и привязывается к создаваемой команде;
  - если `user_id` уже существует — обновляются его данные (`username`, `is_active`) и он **перемещается в новую команду** путем изменения `team_name`.

Таким образом, логика эндпоинта реализует:

- создание новой команды;
- миграцию сотрудников из существующих команд в новую.

### `POST /team/deactivateUsers` (Массовая деактивация)

- Позволяет деактивировать список пользователей.
- Принимает список `users` (ID пользователей).
- Для каждого деактивируемого пользователя:
  - Флаг `is_active` устанавливается в `false`.
  - Для всех открытых PR, где пользователь является ревьювером, происходит поиск замены.
  - Новый ревьювер выбирается случайно из активных участников той же команды (исключая автора PR, самого пользователя и других деактивируемых в этом запросе).
  - Если замена найдена: создается новая запись о назначении, старая помечается как замененная.
  - Если замена не найдена (нет активных кандидатов): назначение удаляется (количество ревьюверов уменьшается).
- Возвращает список обновленных PR с актуальным списком ревьюверов.

**Пример тела запроса:**

```json
{
  "users": [
    "u1",
    "u2",
    "u3"
  ]
}
```

### `POST /pullRequest` (Создание PR)

- При создании PR автоматически выбираются до 2-х случайных ревьюверов из команды автора.
- Автор PR исключается из списка кандидатов.
- Выбираются только пользователи с флагом `is_active = true`.
- Если в команде недостаточно кандидатов, назначается столько, сколько есть (1 или 0).

### `POST /pullRequest/{prId}/reassign` (Переназначение ревьювера)

- Позволяет заменить одного ревьювера на другого из той же команды.
- Новый ревьювер выбирается случайно из активных участников команды.
- Из кандидатов исключаются:
  - Автор PR.
  - Пользователь, которого заменяют.
  - Пользователи, которые **уже назначены** ревьюверами на этот PR (чтобы избежать дублирования).
- Если подходящих кандидатов нет, возвращается ошибка.

### `POST /pullRequest/{prId}/merge` (Слияние PR)

- Операция идемпотентна:
  - Если PR уже имеет статус `MERGED`, сервис возвращает успешный ответ с текущим состоянием PR (не меняя дату слияния).
  - Если PR открыт, статус меняется на `MERGED` и фиксируется время слияния.

### `GET /stats` (Статистика)

Возвращает общую статистику по сервису:

- **Топ ревьюверов**: список пользователей с наибольшим количеством назначенных ревью.
- **Распределение PR**: количество PR в статусах `OPEN` и `MERGED`.
- **Активные пользователи**: общее количество пользователей с флагом `is_active = true`.

## Конфигурация линтера

В проекте используется `golangci-lint` с конфигурацией в файле `.golangci.yml`.
Включены основные линтеры для поддержания качества кода:

- **Базовые проверки**:
  - `govet`: Стандартный статический анализатор Go.
  - `staticcheck`: Продвинутый статический анализ.
  - `errcheck`: Проверка обработки ошибок.
  - `unused`: Поиск неиспользуемого кода.
  - `ineffassign`: Поиск бесполезных присваиваний.

- **Стиль**:
  - `revive`: Проверка стиля кода и комментариев (современная замена `golint`).

Для запуска линтера локально:

```bash
golangci-lint run
```

Результат проверки:

```text
golangci-lint run
0 issues.
```

## Тестирование

Проект включает в себя End-to-End (E2E) тесты и скрипты для нагрузочного тестирования.

Для проверки линтером, E2E, k6 используйте:

```bash
make test
```

### E2E Тестирование

Интеграционные тесты написаны на Go и проверяют полный цикл работы API с реальной базой данных.

**Покрываемые сценарии:**

1. **Создание команды**: проверка корректного создания и добавления участников.
2. **Создание PR**: проверка автоматического назначения ревьюверов из той же команды.
3. **Получение статистики**: проверка доступности эндпоинта.
4. **Массовая деактивация**: проверка логики переназначения ревьюверов при деактивации пользователей.

**Запуск:**

```bash
make test-e2e
```

### Нагрузочное тестирование (k6)

Для проверки производительности используется инструмент [k6](https://k6.io/).

**Параметры нагрузки:**

- **VUs (Virtual Users)**: разгон до 50 одновременных пользователей.
- **Stages**:
  - 10s: разгон до 10 пользователей.
  - 30s: нагрузка 50 пользователей.
  - 10s: спад до 0.
- **Thresholds (SLO)**:
  - 95% запросов должны выполняться быстрее 100мс.
  - Процент ошибок < 1%.

**Запуск:**

Убедитесь, что у вас установлен k6, затем выполните:

```bash
make load-test
```

Дополнительно:

- реализована валидация входных данных:
  - `team_name` не может быть пустым;
  - список `members` не может быть пустым;
  - у каждого участника должен быть указан `username`.
  При нарушении возвращается ошибка `INVALID_INPUT`.

Что можно улучшить:

- Возможность создать и добавить участника к уже существующей команде

### Результаты запуска (23.11.2025)

**E2E Тесты:**

- ✅ Все сценарии (`Create_Team`, `Create_PR`, `Get_Stats`, `Deactivate_User`) прошли успешно.
- Время выполнения: ~0.05s.

**Нагрузочное тестирование (k6):**

- **Checks**: 100% успех (4740/4740 запросов).
- **Latency (p95)**: 7.61ms (цель < 100ms).
- **Error Rate**: 0.00% (цель < 1%).
- **RPS**: ~94 req/s.
